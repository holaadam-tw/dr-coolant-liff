<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Coolant åˆ‡å‰Šæ¶²æª¢æ¸¬</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- â­ v15.3: æ–°å¢ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 30px 20px;
        }

        /* â­ v15.3: åœ–è¡¨æŒ‰éˆ• */
        .chart-btn {
            display: inline-block;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .chart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.3);
        }

        /* â­ v15.3: Modal æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            position: relative;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
        }

        .modal-body {
            padding: 20px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e8ed;
        }

        /* è¨»å†Šè¡¨å–®æ¨£å¼ */
        .register-form {
            display: none;
        }

        .register-form.active {
            display: block;
        }

        .welcome-message {
            text-align: center;
            margin-bottom: 30px;
        }

        .welcome-message h2 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .welcome-message p {
            color: #666;
            font-size: 14px;
        }

        /* èº«ä»½é¸æ“‡å¡ç‰‡ */
        .identity-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .identity-card {
            background: #f8f9fa;
            border: 3px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .identity-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .identity-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .identity-card .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .identity-card .title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .identity-card .desc {
            font-size: 12px;
            opacity: 0.8;
        }

        /* å‹•æ…‹è¡¨å–®å€å¡Š */
        .dynamic-form {
            display: none;
        }

        .dynamic-form.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        /* æª¢æ¸¬è¡¨å–®æ¨£å¼ */
        .inspection-form {
            display: none;
        }

        .inspection-form.active {
            display: block;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .user-info p {
            margin: 5px 0;
            color: #333;
            font-size: 14px;
        }

        .user-info strong {
            color: #667eea;
        }

        .user-info.vendor {
            border-left-color: #fd7e14;
        }

        .user-info.vendor strong {
            color: #fd7e14;
        }

        /* æ©Ÿå°è³‡æ–™åŒæ­¥æç¤º */
        .sync-status {
            background: #d4edda;
            color: #155724;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
            border: 2px solid #c3e6cb;
            display: none;
        }

        .sync-status.show {
            display: block;
        }

        /* ğŸ†• å¯ç·¨è¼¯æ¬„ä½æç¤º */
        .editable-hint {
            background: #fff3cd;
            color: #856404;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            text-align: center;
            border: 2px solid #ffeaa7;
            display: none;
        }

        .editable-hint.show {
            display: block;
        }

        /* è¡¨å–®çµ„ä»¶ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .required {
            color: #e74c3c;
            margin-left: 4px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #aaa;
        }

        .locked-input {
            background-color: #e9ecef !important;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ğŸ†• å¯ç·¨è¼¯ä½†æœ‰æ­·å²å€¼çš„æ¬„ä½æ¨£å¼ */
        .editable-with-history {
            background-color: #fff9e6 !important;
            border-color: #ffc107 !important;
        }

        .form-control.is-filled,
        .form-select.is-filled {
            color: #0d6efd !important;
            font-weight: 700 !important;
            border-color: #0d6efd !important;
            background-color: #f8f9fa !important;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .last-value-hint {
            font-size: 0.75rem;
            color: #28a745;
            margin-top: 3px;
            font-weight: 600;
        }

        /* ğŸ†• å¯ä¿®æ”¹æç¤º */
        .editable-label {
            font-size: 0.7rem;
            color: #ff9800;
            margin-top: 3px;
            font-weight: 600;
        }

        /* æŒ‰éˆ• */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading å‹•ç•« */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading.active {
            display: block;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* éŒ¯èª¤è¨Šæ¯ */
        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        /* æˆåŠŸè¨Šæ¯ */
        .success-message {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .success-message.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¬ Dr. Coolant</h1>
            <p>åˆ‡å‰Šæ¶²æ™ºèƒ½æª¢æ¸¬ç³»çµ± v15.3 ULTIMATE</p>
        </div>

        <div class="content">
            <!-- Loading ç•«é¢ -->
            <div class="loading active" id="loadingScreen">
                <div class="spinner"></div>
                <p id="loadingText">æ­£åœ¨è¼‰å…¥...</p>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div class="error-message" id="errorMessage"></div>

            <!-- æˆåŠŸè¨Šæ¯ -->
            <div class="success-message" id="successMessage"></div>

            <!-- æ©Ÿå°è³‡æ–™åŒæ­¥æç¤º -->
            <div class="sync-status" id="syncStatus">âœ… æ©Ÿå°è³‡æ–™å·²åŒæ­¥</div>

            <!-- ğŸ†• å¯ç·¨è¼¯æ¬„ä½æç¤º -->
            <div class="editable-hint" id="editableHint">
                ğŸ’¡ æ²¹æ§½å®¹é‡èˆ‡ç›®æ¨™æ¿ƒåº¦å·²è¼‰å…¥ä¸Šæ¬¡æ•¸å€¼ï¼Œå¯è‡ªç”±ä¿®æ”¹
            </div>

            <!-- è¨»å†Šè¡¨å–® -->
            <div class="register-form" id="registerForm">
                <div class="welcome-message">
                    <h2>ğŸ‘‹ æ­¡è¿ä½¿ç”¨</h2>
                    <p>é¦–æ¬¡ä½¿ç”¨è«‹å¡«å¯«åŸºæœ¬è³‡æ–™</p>
                </div>

                <!-- èº«ä»½é¸æ“‡ -->
                <div class="identity-selector">
                    <div class="identity-card" data-identity="internal">
                        <div class="icon">ğŸ‘·</div>
                        <div class="title">å…§éƒ¨å“¡å·¥</div>
                        <div class="desc">æ“ä½œå“¡/ç®¡ç†å“¡/å·¥ç¨‹å¸«</div>
                    </div>
                    <div class="identity-card" data-identity="vendor">
                        <div class="icon">ğŸ‘¤</div>
                        <div class="title">å¤–éƒ¨è¨ªå®¢</div>
                        <div class="desc">ä¾›æ‡‰å•†äººå“¡</div>
                    </div>
                </div>

                <!-- å…§éƒ¨å“¡å·¥è¡¨å–® -->
                <div class="dynamic-form" id="internalForm">
                    <form id="internalRegistrationForm">
                        <div class="form-group">
                            <label>å§“å <span class="required">*</span></label>
                            <input 
                                type="text" 
                                id="internalRealName" 
                                placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“åï¼ˆä¾‹ï¼šå¼µä¸‰ï¼‰"
                                required
                                maxlength="20"
                            >
                        </div>

                        <div class="form-group">
                            <label>å…¬å¸ <span class="required">*</span></label>
                            <select id="companyName" required>
                                <option value="">è«‹é¸æ“‡å…¬å¸</option>
                            </select>
                            <p class="help-text">æ‚¨æ‰€å±¬çš„å…¬å¸</p>
                        </div>

                        <div class="form-group">
                            <label>è§’è‰² <span class="required">*</span></label>
                            <select id="internalRole" required>
                                <option value="æ“ä½œå“¡">æ“ä½œå“¡</option>
                                <option value="ç®¡ç†å“¡">ç®¡ç†å“¡</option>
                                <option value="å·¥ç¨‹å¸«">å·¥ç¨‹å¸«</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            å®Œæˆè¨»å†Š
                        </button>
                    </form>
                </div>

                <!-- å¤–éƒ¨è¨ªå®¢è¡¨å–® -->
                <div class="dynamic-form" id="vendorForm">
                    <form id="vendorRegistrationForm">
                        <div class="form-group">
                            <label>å§“å <span class="required">*</span></label>
                            <input 
                                type="text" 
                                id="vendorRealName" 
                                placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“åï¼ˆä¾‹ï¼šæå››ï¼‰"
                                required
                                maxlength="20"
                            >
                        </div>

                        <div class="form-group">
                            <label>ä¾›æ‡‰å•† <span class="required">*</span></label>
                            <select id="vendorName" required>
                                <option value="">è«‹é¸æ“‡ä¾›æ‡‰å•†</option>
                            </select>
                            <p class="help-text">æ‚¨æ‰€å±¬çš„ä¾›æ‡‰å•†å…¬å¸</p>
                        </div>

                        <div class="form-group">
                            <label>è§’è‰²</label>
                            <input 
                                type="text" 
                                value="è¨ªå®¢" 
                                readonly
                                style="background-color: #e9ecef; cursor: not-allowed;"
                            >
                            <p class="help-text">å¤–éƒ¨äººå“¡é è¨­ç‚ºè¨ªå®¢è§’è‰²</p>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            å®Œæˆè¨»å†Š
                        </button>
                    </form>
                </div>
            </div>

            <!-- æª¢æ¸¬è¡¨å–® -->
            <div class="inspection-form" id="inspectionForm">
                <div class="user-info" id="userInfo">
                    <!-- ä½¿ç”¨è€…è³‡è¨Šå°‡ç”± JavaScript å¡«å…… -->
                </div>

                <form id="inspectionFormData">
                    <!-- åŸºæœ¬è³‡è¨Š -->
                    <div class="form-group">
                        <label>æ©Ÿå°ç·¨è™Ÿ <span class="required">*</span></label>
                        <input type="text" id="machineId" placeholder="ä¾‹ï¼šM2025-001" required>
                        <!-- â­ v15.3: æŸ¥çœ‹æ­·å²èµ°å‹¢æŒ‰éˆ• -->
                        <button type="button" class="chart-btn" id="viewChartBtn" style="display:none;">
                            ğŸ“Š æŸ¥çœ‹æ­·å²èµ°å‹¢
                        </button>
                    </div>

                    <div class="form-group">
                        <label>æ©Ÿå°åç¨±</label>
                        <input type="text" id="machineName" placeholder="ä¾‹ï¼šMazak è‡¥åŠ 1">
                    </div>

                    <div class="form-group">
                        <label>å» å•†åç¨±</label>
                        <input type="text" id="vendorNameField" placeholder="ä¾‹ï¼šå¤§æ­£ç§‘æŠ€">
                    </div>

                    <!-- æª¢æ¸¬æ•¸æ“š -->
                    <div class="form-group">
                        <label>åˆ‡å‰Šæ¶²ç¨®é¡ <span class="required">*</span></label>
                        <select id="oilType" required>
                            <option value="">è«‹é¸æ“‡åˆ‡å‰Šæ¶²ç¨®é¡</option>
                            <option value="é¸é … 1ï¼šå…¨åˆæˆ (Fully Synthetic)">é¸é … 1ï¼šå…¨åˆæˆ (Fully Synthetic)</option>
                            <option value="é¸é … 2ï¼šåŠåˆæˆ (Semi-Synthetic)">é¸é … 2ï¼šåŠåˆæˆ (Semi-Synthetic)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>pH å€¼ <span class="required">*</span></label>
                        <input type="number" id="phValue" step="0.1" min="0" max="14" placeholder="ä¾‹ï¼š8.5" required>
                        <div id="phHint" class="help-text">æ­£å¸¸ç¯„åœï¼š8.5 - 9.5</div>
                        <div id="phLastValue" class="last-value-hint"></div>
                    </div>

                    <div class="form-group">
                        <label>ç³–åº¦è¨ˆè®€æ•¸ (%) <span class="required">*</span></label>
                        <input type="number" id="brixReading" step="0.1" min="0" placeholder="ä¾‹ï¼š5.0" required>
                        <div id="brixHint" class="help-text">æ­£å¸¸ç¯„åœï¼š3.0 - 5.0%</div>
                        <div id="brixLastValue" class="last-value-hint"></div>
                    </div>

                    <!-- ğŸ”¥ æ²¹æ§½å®¹é‡ï¼šå¯ç·¨è¼¯ + é¡¯ç¤ºä¸Šæ¬¡æ•¸å€¼ -->
                    <div class="form-group">
                        <label>æ²¹æ§½å®¹é‡ (L) <span class="required">*</span></label>
                        <input type="number" id="tankSize" step="1" min="0" placeholder="ä¾‹ï¼š1000" required>
                        <div id="tankSizeHint" class="editable-label"></div>
                    </div>

                    <!-- ğŸ”¥ ç›®æ¨™æ¿ƒåº¦ï¼šå¯ç·¨è¼¯ + é¡¯ç¤ºä¸Šæ¬¡æ•¸å€¼ -->
                    <div class="form-group">
                        <label>ç›®æ¨™æ¿ƒåº¦ (%)</label>
                        <input type="number" id="targetConc" step="0.1" min="0" placeholder="ä¾‹ï¼š7.0ï¼ˆ0 è¡¨ç¤ºä½¿ç”¨ç³»çµ±é è¨­ï¼‰">
                        <div id="targetConcHint" class="editable-label"></div>
                    </div>

                    <div class="form-group">
                        <label>å°é›»åº¦ (Î¼S/cm)</label>
                        <input type="number" id="conductivity" step="1" min="0" placeholder="ä¾‹ï¼š850ï¼ˆ0 è¡¨ç¤ºæœªæ¸¬é‡ï¼‰">
                    </div>

                    <!-- ç´°èŒæª¢æ¸¬ -->
                    <div class="form-group">
                        <label>ğŸ’§ é›™æ°§æ°´æ°£æ³¡æ¸¬è©¦</label>
                        <select id="bubbleResult">
                            <option value="è«‹é¸æ“‡">è«‹é¸æ“‡</option>
                            <option value="é¸é … 1ï¼šç„¡æ°£æ³¡/å¾®é‡æ°£æ³¡ï¼ˆLevel 1 - å®‰å…¨ï¼‰">é¸é … 1ï¼šç„¡æ°£æ³¡/å¾®é‡æ°£æ³¡ï¼ˆLevel 1 - å®‰å…¨ï¼‰</option>
                            <option value="é¸é … 2ï¼šå°‘é‡æ°£æ³¡ï¼ˆæ±½æ°´ç‹€ï¼‰ï¼ˆLevel 2 - è¼•å¾®æ„ŸæŸ“ï¼‰">é¸é … 2ï¼šå°‘é‡æ°£æ³¡ï¼ˆæ±½æ°´ç‹€ï¼‰ï¼ˆLevel 2 - è¼•å¾®æ„ŸæŸ“ï¼‰</option>
                            <option value="é¸é … 3ï¼šæŒçºŒå†’æ³¡ï¼ˆæ˜é¡¯åæ‡‰ï¼‰ï¼ˆLevel 3 - ä¸­åº¦æ„ŸæŸ“ï¼‰">é¸é … 3ï¼šæŒçºŒå†’æ³¡ï¼ˆæ˜é¡¯åæ‡‰ï¼‰ï¼ˆLevel 3 - ä¸­åº¦æ„ŸæŸ“ï¼‰</option>
                            <option value="é¸é … 4ï¼šå¤§é‡æ°£æ³¡ï¼ˆå•¤é…’æ³¡æ²«ç‹€ï¼‰ï¼ˆLevel 4 - åš´é‡æ„ŸæŸ“ï¼‰">é¸é … 4ï¼šå¤§é‡æ°£æ³¡ï¼ˆå•¤é…’æ³¡æ²«ç‹€ï¼‰ï¼ˆLevel 4 - åš´é‡æ„ŸæŸ“ï¼‰</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ğŸ§ª Dr. Coolant ç´°èŒé¡¯å½±</label>
                        <select id="resazurinColor">
                            <option value="è«‹é¸æ“‡">è«‹é¸æ“‡</option>
                            <option value="é¸é … 1ï¼šğŸ”µ è—è‰²ï¼ˆLevel 1 - å®‰å…¨ï¼‰">é¸é … 1ï¼šğŸ”µ è—è‰²ï¼ˆLevel 1 - å®‰å…¨ï¼‰</option>
                            <option value="é¸é … 2ï¼šğŸŸ£ ç´«è‰²ï¼ˆLevel 2 - è¼•å¾®æ„ŸæŸ“ï¼‰">é¸é … 2ï¼šğŸŸ£ ç´«è‰²ï¼ˆLevel 2 - è¼•å¾®æ„ŸæŸ“ï¼‰</option>
                            <option value="é¸é … 3ï¼šğŸŒ¸ ç²‰ç´…è‰²ï¼ˆLevel 3 - ä¸­åº¦æ„ŸæŸ“ï¼‰">é¸é … 3ï¼šğŸŒ¸ ç²‰ç´…è‰²ï¼ˆLevel 3 - ä¸­åº¦æ„ŸæŸ“ï¼‰</option>
                            <option value="é¸é … 4ï¼šâšª ç„¡è‰²é€æ˜ï¼ˆLevel 4 - åš´é‡æ„ŸæŸ“ï¼‰">é¸é … 4ï¼šâšª ç„¡è‰²é€æ˜ï¼ˆLevel 4 - åš´é‡æ„ŸæŸ“ï¼‰</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>è§€å¯Ÿç—‡ç‹€</label>
                        <textarea id="symptoms" placeholder="ä¾‹ï¼šç™¼è‡­ã€è®Šè‰²ã€æµ®æ²¹ç­‰ï¼ˆé¸å¡«ï¼‰"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        ğŸš€ æäº¤æª¢æ¸¬
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- â­ v15.3: åœ–è¡¨ Modal -->
    <div class="modal" id="chartModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“Š æ­·å²è¶¨å‹¢åˆ†æ</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="chart-title">pH å€¼è¶¨å‹¢</div>
                <div class="chart-container">
                    <canvas id="phChart"></canvas>
                </div>

                <div class="chart-title">ç³–åº¦è¶¨å‹¢</div>
                <div class="chart-container">
                    <canvas id="brixChart"></canvas>
                </div>

                <p style="text-align: center; color: #666; font-size: 12px; margin-top: 20px;">
                    ğŸ’¡ æç¤ºï¼šåœ–è¡¨é¡¯ç¤ºæœ€è¿‘ 7 å¤©çš„æª¢æ¸¬æ•¸æ“š
                </p>
            </div>
        </div>
    </div>

    <script>
        // ========== é…ç½®å€ ==========
        const CONFIG = {
            LIFF_ID: '2008738088-3ae3t9Qw',
            SUPABASE_URL: 'https://zqufrfytzfgpargbzdlk.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxdWZyZnl0emZncGFyZ2J6ZGxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MjEyODksImV4cCI6MjA4MzQ5NzI4OX0.hdRcP-qgtxuLAyvSg1X7X3l4o1zkgyDuEXFZDmR1YuI',
            WEBHOOK_URL: 'https://eo9xer4x4f4gjfi.m.pipedream.net/'
        };

        // ========== å…¨åŸŸè®Šæ•¸ ==========
        let liffProfile = null;
        let userData = null;
        let machineData = null;
        let selectedIdentity = null;
        let companiesList = [];
        let vendorsList = [];
        let phChart = null;
        let brixChart = null;

        // ========== DOM å…ƒç´  ==========
        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            loadingText: document.getElementById('loadingText'),
            errorMessage: document.getElementById('errorMessage'),
            successMessage: document.getElementById('successMessage'),
            syncStatus: document.getElementById('syncStatus'),
            editableHint: document.getElementById('editableHint'),
            registerForm: document.getElementById('registerForm'),
            inspectionForm: document.getElementById('inspectionForm'),
            userInfo: document.getElementById('userInfo'),
            internalForm: document.getElementById('internalForm'),
            vendorForm: document.getElementById('vendorForm'),
            chartModal: document.getElementById('chartModal'),
            viewChartBtn: document.getElementById('viewChartBtn'),
            closeModal: document.getElementById('closeModal')
        };

        // ========== å·¥å…·å‡½å¼ ==========
        
        function updateLoadingText(text) {
            elements.loadingText.textContent = text;
        }

        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.classList.add('active');
            setTimeout(() => elements.errorMessage.classList.remove('active'), 5000);
        }

        function showSuccess(message) {
            elements.successMessage.textContent = message;
            elements.successMessage.classList.add('active');
            setTimeout(() => elements.successMessage.classList.remove('active'), 5000);
        }

        function showSyncStatus() {
            elements.syncStatus.classList.add('show');
            setTimeout(() => elements.syncStatus.classList.remove('show'), 3000);
        }

        function showEditableHint() {
            elements.editableHint.classList.add('show');
            setTimeout(() => elements.editableHint.classList.remove('show'), 5000);
        }

        function markFilled(el) {
            if (el && el.value && el.value.trim() !== '' && el.value !== 'è«‹é¸æ“‡') {
                el.classList.add('is-filled');
            }
        }

        function cleanTestResult(value) {
            const emptyValues = ['', 'è«‹é¸æ“‡', 'æœªé¸æ“‡', 'null', 'undefined'];
            return emptyValues.includes(value) ? 'æœªæª¢æ¸¬' : value;
        }

        function updateHints() {
            const oilType = document.getElementById('oilType').value;
            const phHint = document.getElementById('phHint');
            const brixHint = document.getElementById('brixHint');

            if (oilType.includes('é¸é … 1')) {
                phHint.textContent = 'æ­£å¸¸ç¯„åœï¼š8.5 - 9.5';
                brixHint.textContent = 'æ­£å¸¸ç¯„åœï¼š4.0 - 6.0%';
            } else if (oilType.includes('é¸é … 2')) {
                phHint.textContent = 'æ­£å¸¸ç¯„åœï¼š8.8 - 9.5';
                brixHint.textContent = 'æ­£å¸¸ç¯„åœï¼š6.0 - 8.0%';
            }
        }

        // ========== â­ v15.3: åœ–è¡¨åŠŸèƒ½ ==========
        
        // é–‹å•Ÿåœ–è¡¨ Modal
        elements.viewChartBtn.addEventListener('click', async () => {
            const machineId = document.getElementById('machineId').value.trim();
            if (!machineId) {
                showError('è«‹å…ˆè¼¸å…¥æ©Ÿå°ç·¨è™Ÿ');
                return;
            }

            elements.chartModal.classList.add('active');
            await loadChartData(machineId);
        });

        // é—œé–‰ Modal
        elements.closeModal.addEventListener('click', () => {
            elements.chartModal.classList.remove('active');
        });

        // é»æ“Š Modal èƒŒæ™¯é—œé–‰
        elements.chartModal.addEventListener('click', (e) => {
            if (e.target === elements.chartModal) {
                elements.chartModal.classList.remove('active');
            }
        });

        // è¼‰å…¥åœ–è¡¨è³‡æ–™
        async function loadChartData(machineId) {
            try {
                // æŸ¥è©¢æœ€è¿‘ 7 å¤©çš„æª¢æ¸¬è³‡æ–™
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const response = await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/daily_logs?machine_id=eq.${machineId}&created_at=gte.${sevenDaysAgo.toISOString()}&order=created_at.asc`,
                    {
                        headers: {
                            'apikey': CONFIG.SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    renderCharts(data);
                } else {
                    showError('ç„¡æ³•è¼‰å…¥æ­·å²è³‡æ–™');
                }
            } catch (error) {
                console.error('è¼‰å…¥åœ–è¡¨è³‡æ–™éŒ¯èª¤:', error);
                showError('è¼‰å…¥åœ–è¡¨è³‡æ–™å¤±æ•—');
            }
        }

        // æ¸²æŸ“åœ–è¡¨
        function renderCharts(data) {
            if (data.length === 0) {
                showError('æ­¤æ©Ÿå°å°šç„¡æ­·å²è³‡æ–™');
                return;
            }

            // æº–å‚™è³‡æ–™
            const labels = data.map(d => {
                const date = new Date(d.created_at);
                return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
            });
            const phValues = data.map(d => d.ph_value);
            const brixValues = data.map(d => d.brix_reading);

            // éŠ·æ¯€èˆŠåœ–è¡¨
            if (phChart) phChart.destroy();
            if (brixChart) brixChart.destroy();

            // pH å€¼åœ–è¡¨
            const phCtx = document.getElementById('phChart').getContext('2d');
            phChart = new Chart(phCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'pH å€¼',
                        data: phValues,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `pH: ${context.parsed.y}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 7,
                            max: 10,
                            ticks: { stepSize: 0.5 }
                        }
                    }
                }
            });

            // ç³–åº¦åœ–è¡¨
            const brixCtx = document.getElementById('brixChart').getContext('2d');
            brixChart = new Chart(brixCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ç³–åº¦ (%)',
                        data: brixValues,
                        borderColor: '#f5576c',
                        backgroundColor: 'rgba(245, 87, 108, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `ç³–åº¦: ${context.parsed.y}%`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 10,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // ========== è¼‰å…¥å…¬å¸èˆ‡ä¾›æ‡‰å•†é¸é … ==========
        async function loadMachinesOptions() {
            try {
                const response = await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/machines?select=company_name,vendor`,
                    {
                        headers: {
                            'apikey': CONFIG.SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const machines = await response.json();
                    
                    companiesList = [...new Set(machines.map(m => m.company_name).filter(Boolean))];
                    vendorsList = [...new Set(machines.map(m => m.vendor).filter(Boolean))];

                    const companySelect = document.getElementById('companyName');
                    companiesList.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company;
                        option.textContent = company;
                        companySelect.appendChild(option);
                    });

                    const vendorSelect = document.getElementById('vendorName');
                    vendorsList.forEach(vendor => {
                        const option = document.createElement('option');
                        option.value = vendor;
                        option.textContent = vendor;
                        vendorSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥æ©Ÿå°é¸é …éŒ¯èª¤:', error);
            }
        }

        // ========== èº«ä»½é¸æ“‡é‚è¼¯ ==========
        function setupIdentitySelector() {
            const cards = document.querySelectorAll('.identity-card');
            
            cards.forEach(card => {
                card.addEventListener('click', () => {
                    cards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedIdentity = card.dataset.identity;

                    elements.internalForm.classList.remove('active');
                    elements.vendorForm.classList.remove('active');

                    if (selectedIdentity === 'internal') {
                        elements.internalForm.classList.add('active');
                    } else if (selectedIdentity === 'vendor') {
                        elements.vendorForm.classList.add('active');
                    }
                });
            });
        }

        // ========== LIFF åˆå§‹åŒ– ==========
        async function initializeLiff() {
            try {
                updateLoadingText('æ­£åœ¨åˆå§‹åŒ– LIFF...');
                await liff.init({ liffId: CONFIG.LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                updateLoadingText('æ­£åœ¨å–å¾—ä½¿ç”¨è€…è³‡è¨Š...');
                liffProfile = await liff.getProfile();

                updateLoadingText('æ­£åœ¨è¼‰å…¥é¸é …...');
                await loadMachinesOptions();

                updateLoadingText('æ­£åœ¨æª¢æŸ¥ä½¿ç”¨è€…ç‹€æ…‹...');
                const exists = await checkUserExists(liffProfile.userId);

                if (!exists) {
                    showRegistrationForm();
                } else {
                    updateLoadingText('æ­£åœ¨è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™...');
                    userData = await loadUserData(liffProfile.userId);
                    
                    updateLoadingText('æ­£åœ¨è¼‰å…¥æ©Ÿå°è³‡æ–™...');
                    await loadMachineData();
                    
                    showInspectionForm();
                }
            } catch (error) {
                console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);
                showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        }

        // ========== ä½¿ç”¨è€…ç®¡ç† ==========
        
        async function checkUserExists(userId) {
            try {
                const response = await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/users?user_id=eq.${userId}`,
                    {
                        headers: {
                            'apikey': CONFIG.SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('ç„¡æ³•æª¢æŸ¥ä½¿ç”¨è€…ç‹€æ…‹');
                const data = await response.json();
                return data.length > 0;
            } catch (error) {
                console.error('æª¢æŸ¥ä½¿ç”¨è€…éŒ¯èª¤:', error);
                return false;
            }
        }

        async function loadUserData(userId) {
            try {
                const response = await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/users?user_id=eq.${userId}`,
                    {
                        headers: {
                            'apikey': CONFIG.SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™');
                const data = await response.json();
                
                await updateLastLogin(userId);
                return data[0];
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™éŒ¯èª¤:', error);
                showError('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—');
                return null;
            }
        }

        async function updateLastLogin(userId) {
            try {
                await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/users?user_id=eq.${userId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': CONFIG.SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ last_login: new Date().toISOString() })
                    }
                );
            } catch (error) {
                console.error('æ›´æ–°ç™»å…¥æ™‚é–“éŒ¯èª¤:', error);
            }
        }

        // ========== ğŸ”¥ æ©Ÿå°è³‡æ–™è¼‰å…¥ï¼ˆå¯ç·¨è¼¯ç‰ˆæœ¬ï¼‰==========
        async function loadMachineData() {
            const params = new URLSearchParams(window.location.search);
            let mid = params.get('machine_id');

            if (!mid && liff.getContext()) {
                try {
                    const ctx = liff.getContext();
                    if (ctx && ctx.endpointUrl) {
                        const url = new URL(ctx.endpointUrl);
                        mid = url.searchParams.get('machine_id');
                    }
                } catch (e) {
                    console.log('ç„¡æ³•å¾ LIFF Context å–å¾— machine_id');
                }
            }

            if (mid) {
                document.getElementById('machineId').value = mid;
                document.getElementById('machineId').classList.add('locked-input', 'is-filled');
                document.getElementById('machineId').readOnly = true;
                
                // â­ v15.3: é¡¯ç¤ºæŸ¥çœ‹åœ–è¡¨æŒ‰éˆ•
                elements.viewChartBtn.style.display = 'inline-block';

                try {
                    const response = await fetch(
                        `${CONFIG.SUPABASE_URL}/rest/v1/machines?machine_id=eq.${mid}`,
                        {
                            headers: {
                                'apikey': CONFIG.SUPABASE_KEY,
                                'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                            }
                        }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) {
                            machineData = data[0];
                            fillMachineData(machineData);
                            showSyncStatus();
                            showEditableHint();
                        }
                    }
                } catch (e) {
                    console.error('æ©Ÿå°è³‡æ–™è¼‰å…¥å¤±æ•—', e);
                }
            }
        }

        // ğŸ”¥ ä¿®æ”¹å¾Œçš„ fillMachineDataï¼šcapacity å’Œ target_conc å¯ç·¨è¼¯
        function fillMachineData(data) {
            // åªé–å®šæ©Ÿå°åç¨±èˆ‡å» å•†åç¨±
            const setAndLock = (id, value) => {
                const el = document.getElementById(id);
                if (el && value != null && value !== '') {
                    el.value = value;
                    el.classList.add('locked-input', 'is-filled');
                    el.readOnly = true;
                }
            };

            setAndLock('machineName', data.machine_name);
            setAndLock('vendorNameField', data.vendor);

            // ğŸ”¥ æ²¹æ§½å®¹é‡ï¼šå¯ç·¨è¼¯ï¼Œä½†é¡¯ç¤ºä¸Šæ¬¡æ•¸å€¼
            const tankSizeEl = document.getElementById('tankSize');
            const tankSizeHint = document.getElementById('tankSizeHint');
            if (data.capacity != null && data.capacity !== '') {
                tankSizeEl.value = data.capacity;
                tankSizeEl.classList.add('editable-with-history');
                tankSizeHint.textContent = `âœï¸ ä¸Šæ¬¡ï¼š${data.capacity} Lï¼ˆå¯ä¿®æ”¹ï¼‰`;
                markFilled(tankSizeEl);
            }

            // ğŸ”¥ ç›®æ¨™æ¿ƒåº¦ï¼šå¯ç·¨è¼¯ï¼Œä½†é¡¯ç¤ºä¸Šæ¬¡æ•¸å€¼
            const targetConcEl = document.getElementById('targetConc');
            const targetConcHint = document.getElementById('targetConcHint');
            if (data.target_conc != null && data.target_conc !== '') {
                targetConcEl.value = data.target_conc;
                targetConcEl.classList.add('editable-with-history');
                targetConcHint.textContent = `âœï¸ ä¸Šæ¬¡ï¼š${data.target_conc}%ï¼ˆå¯ä¿®æ”¹ï¼‰`;
                markFilled(targetConcEl);
            }

            // æ²¹å“ç¨®é¡ä»ä¿æŒé–å®š
            if (data.oil_code) {
                const oilType = document.getElementById('oilType');
                const code = String(data.oil_code).trim();
                if (code === '1') {
                    oilType.value = 'é¸é … 1ï¼šå…¨åˆæˆ (Fully Synthetic)';
                } else if (code === '2') {
                    oilType.value = 'é¸é … 2ï¼šåŠåˆæˆ (Semi-Synthetic)';
                }
                markFilled(oilType);
                updateHints();
            }

            // pH èˆ‡ç³–åº¦æç¤º
            if (data.last_ph) {
                document.getElementById('phLastValue').textContent = `ğŸ’¡ ä¸Šæ¬¡ï¼špH ${data.last_ph}`;
            }
            if (data.last_brix) {
                document.getElementById('brixLastValue').textContent = `ğŸ’¡ ä¸Šæ¬¡ï¼š${data.last_brix}%`;
            }
        }

        // ========== é¡¯ç¤ºç•«é¢ ==========
        
        function showRegistrationForm() {
            elements.loadingScreen.classList.remove('active');
            elements.loadingScreen.classList.add('hidden');
            elements.registerForm.classList.add('active');
            setupIdentitySelector();
        }

        function showInspectionForm() {
            elements.loadingScreen.classList.remove('active');
            elements.loadingScreen.classList.add('hidden');
            elements.inspectionForm.classList.add('active');

            const isInternal = userData.is_internal;
            const userInfoClass = isInternal ? '' : 'vendor';
            const companyDisplay = isInternal ? 
                `<p><strong>ğŸ¢ å…¬å¸ï¼š</strong>${userData.company_name || 'æœªè¨­å®š'}</p>` :
                `<p><strong>ğŸ­ ä¾›æ‡‰å•†ï¼š</strong>${userData.vendor_name || 'æœªè¨­å®š'}</p>`;

            elements.userInfo.className = `user-info ${userInfoClass}`;
            elements.userInfo.innerHTML = `
                <p><strong>ğŸ‘¤ æ“ä½œäººå“¡ï¼š</strong>${userData.real_name}</p>
                ${companyDisplay}
                <p><strong>ğŸ‘” è§’è‰²ï¼š</strong>${userData.role}</p>
            `;

            if (isInternal && userData.company_name) {
                const vendorField = document.getElementById('vendorNameField');
                if (!vendorField.readOnly) {
                    vendorField.value = userData.company_name;
                }
            }
        }

        // ========== è¨»å†Šè¡¨å–®è™•ç† ==========
        
        document.getElementById('internalRegistrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const realName = document.getElementById('internalRealName').value.trim();
            const companyName = document.getElementById('companyName').value;
            const role = document.getElementById('internalRole').value;

            if (!realName || !companyName) {
                showError('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'è¨»å†Šä¸­...';

            try {
                const response = await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/users`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': CONFIG.SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            user_id: liffProfile.userId,
                            real_name: realName,
                            role: role,
                            is_internal: true,
                            company_name: companyName,
                            company_code: null,
                            vendor_name: null,
                            last_login: new Date().toISOString()
                        })
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'è¨»å†Šå¤±æ•—');
                }

                const data = await response.json();
                userData = data[0];

                showSuccess('è¨»å†ŠæˆåŠŸï¼');
                await loadMachineData();

                setTimeout(() => {
                    elements.registerForm.classList.remove('active');
                    showInspectionForm();
                }, 1000);

            } catch (error) {
                console.error('è¨»å†ŠéŒ¯èª¤:', error);
                showError('è¨»å†Šå¤±æ•—ï¼š' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'å®Œæˆè¨»å†Š';
            }
        });

        document.getElementById('vendorRegistrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const realName = document.getElementById('vendorRealName').value.trim();
            const vendorName = document.getElementById('vendorName').value;

            if (!realName || !vendorName) {
                showError('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'è¨»å†Šä¸­...';

            try {
                const response = await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/users`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': CONFIG.SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            user_id: liffProfile.userId,
                            real_name: realName,
                            role: 'è¨ªå®¢',
                            is_internal: false,
                            company_name: null,
                            company_code: null,
                            vendor_name: vendorName,
                            last_login: new Date().toISOString()
                        })
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'è¨»å†Šå¤±æ•—');
                }

                const data = await response.json();
                userData = data[0];

                showSuccess('è¨»å†ŠæˆåŠŸï¼');
                await loadMachineData();

                setTimeout(() => {
                    elements.registerForm.classList.remove('active');
                    showInspectionForm();
                }, 1000);

            } catch (error) {
                console.error('è¨»å†ŠéŒ¯èª¤:', error);
                showError('è¨»å†Šå¤±æ•—ï¼š' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'å®Œæˆè¨»å†Š';
            }
        });

        // ========== æª¢æ¸¬è¡¨å–®è™•ç† ==========
        document.getElementById('inspectionFormData').addEventListener('submit', async (e) => {
            e.preventDefault();

            const machineId = document.getElementById('machineId').value.trim();
            const phValue = parseFloat(document.getElementById('phValue').value) || 0;
            const brixReading = parseFloat(document.getElementById('brixReading').value) || 0;
            const tankSize = parseFloat(document.getElementById('tankSize').value) || 0;
            const oilType = document.getElementById('oilType').value;
            
            const bubbleResult = cleanTestResult(document.getElementById('bubbleResult').value);
            const resazurinColor = cleanTestResult(document.getElementById('resazurinColor').value);

            const formData = {
                userId: liffProfile.userId,
                realName: userData.real_name,
                role: userData.role,
                isInternal: userData.is_internal,
                companyName: userData.is_internal ? userData.company_name : null,
                vendorName: !userData.is_internal ? userData.vendor_name : null,
                
                machineId: machineId,
                machineName: document.getElementById('machineName').value.trim() || 'æœªæä¾›',
                vendorNameField: document.getElementById('vendorNameField').value.trim() || 'æœªè¨­å®š',
                
                oilType: oilType,
                phValue: phValue,
                brixReading: brixReading,
                tankSize: tankSize,
                targetConc: parseFloat(document.getElementById('targetConc').value) || 0,
                conductivity: parseFloat(document.getElementById('conductivity').value) || 0,
                bubbleResult: bubbleResult,
                resazurinColor: resazurinColor,
                symptoms: document.getElementById('symptoms').value || ''
            };

            if (!machineId || !oilType) {
                showError('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';

            try {
                // æ›´æ–°æ©Ÿå°è³‡æ–™ï¼ˆåŒ…å« capacity å’Œ target_concï¼‰
                if (machineData) {
                    const oilCode = oilType.includes('é¸é … 1') ? '1' : '2';
                    await fetch(
                        `${CONFIG.SUPABASE_URL}/rest/v1/machines?machine_id=eq.${machineId}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'apikey': CONFIG.SUPABASE_KEY,
                                'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                capacity: tankSize,
                                target_conc: formData.targetConc,
                                oil_code: oilCode,
                                last_ph: phValue,
                                last_brix: brixReading,
                                last_checked: new Date().toISOString()
                            })
                        }
                    );
                }

                const response = await fetch(CONFIG.WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) throw new Error('æäº¤å¤±æ•—');

                showSuccess('æª¢æ¸¬è³‡æ–™å·²æäº¤ï¼å ±å‘Šå°‡é€é LINE ç™¼é€çµ¦æ‚¨ã€‚');

                setTimeout(() => {
                    if (liff.isInClient()) {
                        liff.closeWindow();
                    }
                }, 2000);

            } catch (error) {
                console.error('æäº¤éŒ¯èª¤:', error);
                showError('æäº¤å¤±æ•—ï¼Œè«‹é‡è©¦');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸš€ æäº¤æª¢æ¸¬';
            }
        });

        // ========== äº‹ä»¶ç›£è½ ==========
        document.getElementById('oilType').addEventListener('change', updateHints);

        document.querySelectorAll('.form-control, .form-select').forEach(el => {
            el.addEventListener('input', () => markFilled(el));
            el.addEventListener('change', () => markFilled(el));
        });

        // â­ v15.3: æ©Ÿå°ç·¨è™Ÿè®Šæ›´æ™‚é¡¯ç¤º/éš±è—åœ–è¡¨æŒ‰éˆ•
        document.getElementById('machineId').addEventListener('input', (e) => {
            const machineId = e.target.value.trim();
            elements.viewChartBtn.style.display = machineId ? 'inline-block' : 'none';
        });

        // ========== é é¢è¼‰å…¥ ==========
        window.addEventListener('DOMContentLoaded', () => {
            initializeLiff();
        });
    </script>
</body>
</html>
