"""
Dr. Coolant v15.3 ULTIMATE - Pipedream Webhook
æ”¯æ´ v15.2 çš„ company_name/vendor_name æ¬„ä½èˆ‡å‹•æ…‹è§’è‰²é‚è¼¯
"""
import requests
from datetime import datetime

def handler(pd: "pipedream"):
    # ============================================================
    # ğŸ”§ è¨­å®šå€ï¼ˆè«‹æ›¿æ›ç‚ºå¯¦éš›å€¼ï¼‰
    # ============================================================
    SUPABASE_URL = "https://zqufrfytzfgpargbzdlk.supabase.co"
    SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxdWZyZnl0emZncGFyZ2J6ZGxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MjEyODksImV4cCI6MjA4MzQ5NzI4OX0.hdRcP-qgtxuLAyvSg1X7X3l4o1zkgyDuEXFZDmR1YuI"
    
    # Dify å·¥ä½œæµè¨­å®š
    DIFY_API_KEY = "[è«‹æ›¿æ›ç‚ºæ‚¨çš„ Dify API Key]"
    DIFY_WORKFLOW_URL = "https://api.dify.ai/v1/workflows/run"
    
    # LINE Notify Tokenï¼ˆé¸å¡«ï¼Œç”¨æ–¼ç·Šæ€¥é€šçŸ¥ï¼‰
    LINE_NOTIFY_TOKEN = "[é¸å¡«]"
    
    # ============================================================
    # 1ï¸âƒ£ è§£æå‰ç«¯é€ä¾†çš„è³‡æ–™
    # ============================================================
    try:
        payload = pd.steps["trigger"]["event"]["body"]
        print(f"âœ… æ”¶åˆ°è³‡æ–™: {payload}")
    except Exception as e:
        return {"error": f"è§£æè«‹æ±‚å¤±æ•—: {str(e)}"}
    
    # å–å¾—é—œéµæ¬„ä½
    user_id = payload.get("userId")
    real_name = payload.get("realName")
    company_name = payload.get("companyName")  # v15.2 æ–°å¢
    vendor_name = payload.get("vendorName")    # v15.2 æ–°å¢
    is_internal = payload.get("isInternal", True)  # v15.2 æ–°å¢
    role = payload.get("role")
    machine_id = payload.get("machineId")
    
    # æª¢æ¸¬æ•¸æ“š
    ph_value = payload.get("phValue")
    brix = payload.get("brix")
    conductivity = payload.get("conductivity")
    bubble_result = payload.get("bubbleResult")
    resazurin_color = payload.get("resazurinColor")
    symptoms = payload.get("symptoms")
    
    # ============================================================
    # 2ï¸âƒ£ å¾ Supabase å–å¾—ä½¿ç”¨è€…èˆ‡æ©Ÿå°è³‡è¨Š
    # ============================================================
    headers = {
        "apikey": SUPABASE_KEY,
        "Authorization": f"Bearer {SUPABASE_KEY}",
        "Content-Type": "application/json"
    }
    
    # å–å¾—ä½¿ç”¨è€…å®Œæ•´è³‡æ–™
    try:
        user_response = requests.get(
            f"{SUPABASE_URL}/rest/v1/users?user_id=eq.{user_id}",
            headers=headers
        )
        user_data = user_response.json()[0] if user_response.ok and user_response.json() else {}
        print(f"âœ… ä½¿ç”¨è€…è³‡æ–™: {user_data}")
    except Exception as e:
        print(f"âš ï¸ ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™: {e}")
        user_data = {}
    
    # å–å¾—æ©Ÿå°è³‡æ–™
    try:
        machine_response = requests.get(
            f"{SUPABASE_URL}/rest/v1/machines?machine_id=eq.{machine_id}",
            headers=headers
        )
        machine_data = machine_response.json()[0] if machine_response.ok and machine_response.json() else {}
        print(f"âœ… æ©Ÿå°è³‡æ–™: {machine_data}")
    except Exception as e:
        print(f"âš ï¸ ç„¡æ³•å–å¾—æ©Ÿå°è³‡æ–™: {e}")
        machine_data = {}
    
    # ============================================================
    # 3ï¸âƒ£ å¯«å…¥ daily_logs è¡¨
    # ============================================================
    log_entry = {
        "machine_id": machine_id,
        "company_name": company_name or machine_data.get("company_name"),
        "vendor_name": vendor_name or machine_data.get("vendor"),
        "operator_id": user_id,
        "operator_name": real_name or user_data.get("real_name"),
        "operator_role": role or user_data.get("role"),
        "operator_company": company_name if is_internal else vendor_name,
        "ph_value": float(ph_value) if ph_value else None,
        "brix": float(brix) if brix else None,
        "conductivity": float(conductivity) if conductivity else None,
        "bubble_result": bubble_result,
        "resazurin_color": resazurin_color,
        "symptoms": symptoms,
        "created_at": datetime.utcnow().isoformat()
    }
    
    try:
        log_response = requests.post(
            f"{SUPABASE_URL}/rest/v1/daily_logs",
            json=log_entry,
            headers=headers
        )
        if log_response.ok:
            print(f"âœ… æˆåŠŸå¯«å…¥ daily_logs: {log_response.json()}")
        else:
            print(f"âŒ å¯«å…¥ daily_logs å¤±æ•—: {log_response.status_code} - {log_response.text}")
            return {"error": "è³‡æ–™åº«å¯«å…¥å¤±æ•—", "details": log_response.text}
    except Exception as e:
        print(f"âŒ daily_logs å¯«å…¥ç•°å¸¸: {e}")
        return {"error": f"è³‡æ–™åº«ç•°å¸¸: {str(e)}"}
    
    # ============================================================
    # 4ï¸âƒ£ å‘¼å« Dify å·¥ä½œæµç”Ÿæˆå ±å‘Š
    # ============================================================
    dify_payload = {
        "inputs": {
            "machine_id": machine_id,
            "machine_name": machine_data.get("machine_name", "æœªçŸ¥æ©Ÿå°"),
            "company_name": company_name or machine_data.get("company_name"),
            "vendor_name": vendor_name or machine_data.get("vendor"),
            "operator_name": real_name,
            "operator_role": role,
            "ph_value": ph_value,
            "brix": brix,
            "conductivity": conductivity,
            "bubble_result": bubble_result,
            "resazurin_color": resazurin_color,
            "symptoms": symptoms,
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        },
        "response_mode": "blocking",
        "user": user_id
    }
    
    dify_headers = {
        "Authorization": f"Bearer {DIFY_API_KEY}",
        "Content-Type": "application/json"
    }
    
    try:
        dify_response = requests.post(
            DIFY_WORKFLOW_URL,
            json=dify_payload,
            headers=dify_headers,
            timeout=30
        )
        
        if dify_response.ok:
            dify_result = dify_response.json()
            print(f"âœ… Dify å ±å‘Šç”ŸæˆæˆåŠŸ: {dify_result.get('data', {}).get('outputs', {})}")
            report = dify_result.get("data", {}).get("outputs", {}).get("report", "å ±å‘Šç”Ÿæˆä¸­...")
        else:
            print(f"âš ï¸ Dify å‘¼å«å¤±æ•—: {dify_response.status_code} - {dify_response.text}")
            report = f"âš ï¸ AI å ±å‘Šç”Ÿæˆå¤±æ•—ï¼ˆ{dify_response.status_code}ï¼‰"
    except Exception as e:
        print(f"âŒ Dify å‘¼å«ç•°å¸¸: {e}")
        report = f"âŒ AI å ±å‘Šç•°å¸¸: {str(e)}"
    
    # ============================================================
    # 5ï¸âƒ£ è¿”å›çµæœçµ¦å‰ç«¯
    # ============================================================
    return {
        "success": True,
        "message": "âœ… æª¢æ¸¬è³‡æ–™å·²æˆåŠŸè¨˜éŒ„ï¼",
        "data": {
            "log_id": log_response.json()[0].get("id") if log_response.ok else None,
            "machine_id": machine_id,
            "operator": real_name,
            "company": company_name if is_internal else vendor_name,
            "role": role,
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "ai_report": report
        }
    }
