<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Coolant åˆ‡å‰Šæ¶²æª¢æ¸¬</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 30px 20px;
        }

        /* è¨»å†Šè¡¨å–®æ¨£å¼ */
        .register-form {
            display: none;
        }

        .register-form.active {
            display: block;
        }

        .welcome-message {
            text-align: center;
            margin-bottom: 30px;
        }

        .welcome-message h2 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .welcome-message p {
            color: #666;
            font-size: 14px;
        }

        /* æª¢æ¸¬è¡¨å–®æ¨£å¼ */
        .inspection-form {
            display: none;
        }

        .inspection-form.active {
            display: block;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .user-info p {
            margin: 5px 0;
            color: #333;
            font-size: 14px;
        }

        .user-info strong {
            color: #667eea;
        }

        /* â­ v15.1: æ©Ÿå°è³‡æ–™åŒæ­¥æç¤º */
        .sync-status {
            background: #d4edda;
            color: #155724;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
            border: 2px solid #c3e6cb;
            display: none;
        }

        .sync-status.show {
            display: block;
        }

        /* è¡¨å–®çµ„ä»¶ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .required {
            color: #e74c3c;
            margin-left: 4px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #aaa;
        }

        /* â­ v15.1: é–å®šæ¬„ä½æ¨£å¼ (è‡ªå‹•å¸¶å…¥çš„æ¬„ä½) */
        .locked-input {
            background-color: #e9ecef !important;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* â­ v15.1: å·²å¡«å¯«æ¬„ä½é«˜äº® */
        .form-control.is-filled,
        .form-select.is-filled {
            color: #0d6efd !important;
            font-weight: 700 !important;
            border-color: #0d6efd !important;
            background-color: #f8f9fa !important;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* â­ v15.1: æ­·å²æ•¸æ“šæç¤º */
        .last-value-hint {
            font-size: 0.75rem;
            color: #28a745;
            margin-top: 3px;
            font-weight: 600;
        }

        /* æŒ‰éˆ• */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading å‹•ç•« */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading.active {
            display: block;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* éŒ¯èª¤è¨Šæ¯ */
        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        /* æˆåŠŸè¨Šæ¯ */
        .success-message {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .success-message.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¬ Dr. Coolant</h1>
            <p>åˆ‡å‰Šæ¶²æ™ºèƒ½æª¢æ¸¬ç³»çµ± v15.1 ULTIMATE</p>
        </div>

        <div class="content">
            <!-- Loading ç•«é¢ -->
            <div class="loading active" id="loadingScreen">
                <div class="spinner"></div>
                <p id="loadingText">æ­£åœ¨è¼‰å…¥...</p>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div class="error-message" id="errorMessage"></div>

            <!-- æˆåŠŸè¨Šæ¯ -->
            <div class="success-message" id="successMessage"></div>

            <!-- æ©Ÿå°è³‡æ–™åŒæ­¥æç¤º -->
            <div class="sync-status" id="syncStatus">âœ… æ©Ÿå°è³‡æ–™å·²åŒæ­¥</div>

            <!-- è¨»å†Šè¡¨å–® -->
            <div class="register-form" id="registerForm">
                <div class="welcome-message">
                    <h2>ğŸ‘‹ æ­¡è¿ä½¿ç”¨</h2>
                    <p>é¦–æ¬¡ä½¿ç”¨è«‹å¡«å¯«åŸºæœ¬è³‡æ–™</p>
                </div>

                <form id="registrationForm">
                    <div class="form-group">
                        <label>
                            å§“å <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="realName" 
                            placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“åï¼ˆä¾‹ï¼šå¼µä¸‰ï¼‰"
                            required
                            maxlength="20"
                        >
                        <p class="help-text">æ­¤å§“åå°‡é¡¯ç¤ºåœ¨æª¢æ¸¬å ±å‘Šä¸­</p>
                    </div>

                    <div class="form-group">
                        <label>å…¬å¸/å» å•†</label>
                        <select id="companyCode">
                            <option value="F001">å¤§æ­£ç§‘æŠ€</option>
                            <option value="F002">Propiston</option>
                            <option value="F003">å¸¸éŠ˜</option>
                            <option value="OTHER">å…¶ä»–</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>è§’è‰²</label>
                        <select id="userRole">
                            <option value="æ“ä½œå“¡" selected>æ“ä½œå“¡</option>
                            <option value="ç®¡ç†å“¡">ç®¡ç†å“¡</option>
                            <option value="å·¥ç¨‹å¸«">å·¥ç¨‹å¸«</option>
                            <option value="è¨ªå®¢">è¨ªå®¢</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        å®Œæˆè¨»å†Š
                    </button>
                </form>
            </div>

            <!-- æª¢æ¸¬è¡¨å–® -->
            <div class="inspection-form" id="inspectionForm">
                <div class="user-info" id="userInfo">
                    <!-- ä½¿ç”¨è€…è³‡è¨Šå°‡ç”± JavaScript å¡«å…… -->
                </div>

                <form id="inspectionFormData">
                    <!-- åŸºæœ¬è³‡è¨Š -->
                    <div class="form-group">
                        <label>æ©Ÿå°ç·¨è™Ÿ <span class="required">*</span></label>
                        <input type="text" id="machineId" placeholder="ä¾‹ï¼šM2025-001" required>
                    </div>

                    <div class="form-group">
                        <label>æ©Ÿå°åç¨±</label>
                        <input type="text" id="machineName" placeholder="ä¾‹ï¼šMazak è‡¥åŠ 1">
                    </div>

                    <div class="form-group">
                        <label>å» å•†åç¨±</label>
                        <input type="text" id="vendorName" placeholder="ä¾‹ï¼šå¤§æ­£ç§‘æŠ€">
                    </div>

                    <!-- æª¢æ¸¬æ•¸æ“š -->
                    <div class="form-group">
                        <label>åˆ‡å‰Šæ¶²ç¨®é¡ <span class="required">*</span></label>
                        <select id="oilType" required>
                            <option value="">è«‹é¸æ“‡åˆ‡å‰Šæ¶²ç¨®é¡</option>
                            <option value="é¸é … 1ï¼šå…¨åˆæˆ (Fully Synthetic)">é¸é … 1ï¼šå…¨åˆæˆ (Fully Synthetic)</option>
                            <option value="é¸é … 2ï¼šåŠåˆæˆ (Semi-Synthetic)">é¸é … 2ï¼šåŠåˆæˆ (Semi-Synthetic)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>pH å€¼ <span class="required">*</span></label>
                        <input type="number" id="phValue" step="0.1" min="0" max="14" placeholder="ä¾‹ï¼š8.5" required>
                        <div id="phHint" class="help-text">æ­£å¸¸ç¯„åœï¼š8.5 - 9.5</div>
                        <div id="phLastValue" class="last-value-hint"></div>
                    </div>

                    <div class="form-group">
                        <label>ç³–åº¦è¨ˆè®€æ•¸ (%) <span class="required">*</span></label>
                        <input type="number" id="brixReading" step="0.1" min="0" placeholder="ä¾‹ï¼š5.0" required>
                        <div id="brixHint" class="help-text">æ­£å¸¸ç¯„åœï¼š3.0 - 5.0%</div>
                        <div id="brixLastValue" class="last-value-hint"></div>
                    </div>

                    <div class="form-group">
                        <label>æ²¹æ§½å®¹é‡ (L) <span class="required">*</span></label>
                        <input type="number" id="tankSize" step="1" min="0" placeholder="ä¾‹ï¼š1000" required>
                    </div>

                    <div class="form-group">
                        <label>ç›®æ¨™æ¿ƒåº¦ (%)</label>
                        <input type="number" id="targetConc" step="0.1" min="0" placeholder="ä¾‹ï¼š7.0ï¼ˆ0 è¡¨ç¤ºä½¿ç”¨ç³»çµ±é è¨­ï¼‰">
                    </div>

                    <div class="form-group">
                        <label>å°é›»åº¦ (Î¼S/cm)</label>
                        <input type="number" id="conductivity" step="1" min="0" placeholder="ä¾‹ï¼š850ï¼ˆ0 è¡¨ç¤ºæœªæ¸¬é‡ï¼‰">
                    </div>

                    <!-- ç´°èŒæª¢æ¸¬ -->
                    <div class="form-group">
                        <label>ğŸ’§ é›™æ°§æ°´æ°£æ³¡æ¸¬è©¦</label>
                        <select id="bubbleResult">
                            <option value="è«‹é¸æ“‡">è«‹é¸æ“‡</option>
                            <option value="é¸é … 1ï¼šç„¡æ°£æ³¡/å¾®é‡æ°£æ³¡ï¼ˆLevel 1 - å®‰å…¨ï¼‰">é¸é … 1ï¼šç„¡æ°£æ³¡/å¾®é‡æ°£æ³¡ï¼ˆLevel 1 - å®‰å…¨ï¼‰</option>
                            <option value="é¸é … 2ï¼šå°‘é‡æ°£æ³¡ï¼ˆæ±½æ°´ç‹€ï¼‰ï¼ˆLevel 2 - è¼•å¾®æ„ŸæŸ“ï¼‰">é¸é … 2ï¼šå°‘é‡æ°£æ³¡ï¼ˆæ±½æ°´ç‹€ï¼‰ï¼ˆLevel 2 - è¼•å¾®æ„ŸæŸ“ï¼‰</option>
                            <option value="é¸é … 3ï¼šæŒçºŒå†’æ³¡ï¼ˆæ˜é¡¯åæ‡‰ï¼‰ï¼ˆLevel 3 - ä¸­åº¦æ„ŸæŸ“ï¼‰">é¸é … 3ï¼šæŒçºŒå†’æ³¡ï¼ˆæ˜é¡¯åæ‡‰ï¼‰ï¼ˆLevel 3 - ä¸­åº¦æ„ŸæŸ“ï¼‰</option>
                            <option value="é¸é … 4ï¼šå¤§é‡æ°£æ³¡ï¼ˆå•¤é…’æ³¡æ²«ç‹€ï¼‰ï¼ˆLevel 4 - åš´é‡æ„ŸæŸ“ï¼‰">é¸é … 4ï¼šå¤§é‡æ°£æ³¡ï¼ˆå•¤é…’æ³¡æ²«ç‹€ï¼‰ï¼ˆLevel 4 - åš´é‡æ„ŸæŸ“ï¼‰</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ğŸ§ª Dr. Coolant ç´°èŒé¡¯å½±</label>
                        <select id="resazurinColor">
                            <option value="è«‹é¸æ“‡">è«‹é¸æ“‡</option>
                            <option value="é¸é … 1ï¼šğŸ”µ è—è‰²ï¼ˆLevel 1 - å®‰å…¨ï¼‰">é¸é … 1ï¼šğŸ”µ è—è‰²ï¼ˆLevel 1 - å®‰å…¨ï¼‰</option>
                            <option value="é¸é … 2ï¼šğŸŸ£ ç´«è‰²ï¼ˆLevel 2 - è¼•å¾®æ„ŸæŸ“ï¼‰">é¸é … 2ï¼šğŸŸ£ ç´«è‰²ï¼ˆLevel 2 - è¼•å¾®æ„ŸæŸ“ï¼‰</option>
                            <option value="é¸é … 3ï¼šğŸŒ¸ ç²‰ç´…è‰²ï¼ˆLevel 3 - ä¸­åº¦æ„ŸæŸ“ï¼‰">é¸é … 3ï¼šğŸŒ¸ ç²‰ç´…è‰²ï¼ˆLevel 3 - ä¸­åº¦æ„ŸæŸ“ï¼‰</option>
                            <option value="é¸é … 4ï¼šâšª ç„¡è‰²é€æ˜ï¼ˆLevel 4 - åš´é‡æ„ŸæŸ“ï¼‰">é¸é … 4ï¼šâšª ç„¡è‰²é€æ˜ï¼ˆLevel 4 - åš´é‡æ„ŸæŸ“ï¼‰</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>è§€å¯Ÿç—‡ç‹€</label>
                        <textarea id="symptoms" placeholder="ä¾‹ï¼šç™¼è‡­ã€è®Šè‰²ã€æµ®æ²¹ç­‰ï¼ˆé¸å¡«ï¼‰"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        ğŸš€ æäº¤æª¢æ¸¬
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ========== é…ç½®å€ ==========
        const CONFIG = {
            LIFF_ID: '2008738088-3ae3t9Qw',
            SUPABASE_URL: 'https://zqufrfytzfgpargbzdlk.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxdWZyZnl0emZncGFyZ2J6ZGxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MjEyODksImV4cCI6MjA4MzQ5NzI4OX0.hdRcP-qgtxuLAyvSg1X7X3l4o1zkgyDuEXFZDmR1YuI',
            WEBHOOK_URL: 'https://eo9xer4x4f4gjfi.m.pipedream.net/'
        };

        // ========== å…¨åŸŸè®Šæ•¸ ==========
        let liffProfile = null;
        let userData = null;
        let machineData = null;

        // ========== DOM å…ƒç´  ==========
        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            loadingText: document.getElementById('loadingText'),
            errorMessage: document.getElementById('errorMessage'),
            successMessage: document.getElementById('successMessage'),
            syncStatus: document.getElementById('syncStatus'),
            registerForm: document.getElementById('registerForm'),
            inspectionForm: document.getElementById('inspectionForm'),
            userInfo: document.getElementById('userInfo')
        };

        // ========== å·¥å…·å‡½å¼ ==========
        
        // æ›´æ–° Loading æ–‡å­—
        function updateLoadingText(text) {
            elements.loadingText.textContent = text;
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.classList.add('active');
            setTimeout(() => {
                elements.errorMessage.classList.remove('active');
            }, 5000);
        }

        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        function showSuccess(message) {
            elements.successMessage.textContent = message;
            elements.successMessage.classList.add('active');
            setTimeout(() => {
                elements.successMessage.classList.remove('active');
            }, 5000);
        }

        // é¡¯ç¤ºåŒæ­¥ç‹€æ…‹
        function showSyncStatus() {
            elements.syncStatus.classList.add('show');
            setTimeout(() => {
                elements.syncStatus.classList.remove('show');
            }, 3000);
        }

        // æ¨™è¨˜å·²å¡«å¯«æ¬„ä½
        function markFilled(el) {
            if (el && el.value && el.value.trim() !== '' && el.value !== 'è«‹é¸æ“‡') {
                el.classList.add('is-filled');
            }
        }

        // â­ v15.1: æ¸…ç†æ¸¬è©¦çµæœ
        function cleanTestResult(value) {
            const emptyValues = ['', 'è«‹é¸æ“‡', 'æœªé¸æ“‡', 'null', 'undefined'];
            if (emptyValues.includes(value)) {
                return 'æœªæª¢æ¸¬';
            }
            return value;
        }

        // â­ v15.1: æ›´æ–° pH/Brix æç¤º
        function updateHints() {
            const oilType = document.getElementById('oilType').value;
            const phHint = document.getElementById('phHint');
            const brixHint = document.getElementById('brixHint');

            if (oilType.includes('é¸é … 1')) {
                phHint.textContent = 'æ­£å¸¸ç¯„åœï¼š8.5 - 9.5';
                brixHint.textContent = 'æ­£å¸¸ç¯„åœï¼š4.0 - 6.0%';
            } else if (oilType.includes('é¸é … 2')) {
                phHint.textContent = 'æ­£å¸¸ç¯„åœï¼š8.8 - 9.5';
                brixHint.textContent = 'æ­£å¸¸ç¯„åœï¼š6.0 - 8.0%';
            }
        }

        // å–å¾—å…¬å¸åç¨±
        function getCompanyName(code) {
            const companies = {
                'F001': 'å¤§æ­£ç§‘æŠ€',
                'F002': 'Propiston',
                'F003': 'å¸¸éŠ˜',
                'OTHER': 'å…¶ä»–'
            };
            return companies[code] || 'æœªè¨­å®š';
        }

        // ========== LIFF åˆå§‹åŒ– ==========
        async function initializeLiff() {
            try {
                updateLoadingText('æ­£åœ¨åˆå§‹åŒ– LIFF...');
                await liff.init({ liffId: CONFIG.LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // å–å¾— LINE ä½¿ç”¨è€…è³‡è¨Š
                updateLoadingText('æ­£åœ¨å–å¾—ä½¿ç”¨è€…è³‡è¨Š...');
                liffProfile = await liff.getProfile();
                console.log('LINE User ID:', liffProfile.userId);

                // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²è¨»å†Š
                updateLoadingText('æ­£åœ¨æª¢æŸ¥ä½¿ç”¨è€…ç‹€æ…‹...');
                const exists = await checkUserExists(liffProfile.userId);

                if (!exists) {
                    // é¦–æ¬¡ä½¿ç”¨ï¼Œé¡¯ç¤ºè¨»å†Šè¡¨å–®
                    showRegistrationForm();
                } else {
                    // å·²è¨»å†Šï¼Œè¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
                    updateLoadingText('æ­£åœ¨è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™...');
                    userData = await loadUserData(liffProfile.userId);
                    
                    // â­ v15.1: è¼‰å…¥æ©Ÿå°è³‡æ–™
                    updateLoadingText('æ­£åœ¨è¼‰å…¥æ©Ÿå°è³‡æ–™...');
                    await loadMachineData();
                    
                    // é¡¯ç¤ºæª¢æ¸¬è¡¨å–®
                    showInspectionForm();
                }
            } catch (error) {
                console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);
                showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        }

        // ========== ä½¿ç”¨è€…ç®¡ç† ==========
        
        // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å­˜åœ¨
        async function checkUserExists(userId) {
            try {
                const response = await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/users?user_id=eq.${userId}`,
                    {
                        headers: {
                            'apikey': CONFIG.SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('ç„¡æ³•æª¢æŸ¥ä½¿ç”¨è€…ç‹€æ…‹');
                }

                const data = await response.json();
                return data.length > 0;
            } catch (error) {
                console.error('æª¢æŸ¥ä½¿ç”¨è€…éŒ¯èª¤:', error);
                return false;
            }
        }

        // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
        async function loadUserData(userId) {
            try {
                const response = await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/users?user_id=eq.${userId}`,
                    {
                        headers: {
                            'apikey': CONFIG.SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™');
                }

                const data = await response.json();
                
                // æ›´æ–°æœ€å¾Œç™»å…¥æ™‚é–“
                await updateLastLogin(userId);
                
                return data[0];
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™éŒ¯èª¤:', error);
                showError('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—');
                return null;
            }
        }

        // æ›´æ–°æœ€å¾Œç™»å…¥æ™‚é–“
        async function updateLastLogin(userId) {
            try {
                await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/users?user_id=eq.${userId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': CONFIG.SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            last_login: new Date().toISOString()
                        })
                    }
                );
            } catch (error) {
                console.error('æ›´æ–°ç™»å…¥æ™‚é–“éŒ¯èª¤:', error);
            }
        }

        // â­ v15.1: è¼‰å…¥æ©Ÿå°è³‡æ–™
        async function loadMachineData() {
            // å˜—è©¦å¾ URL å–å¾— machine_id
            const params = new URLSearchParams(window.location.search);
            let mid = params.get('machine_id');

            // å¦‚æœ URL æ²’æœ‰ï¼Œå˜—è©¦å¾ LIFF Context å–å¾—
            if (!mid && liff.getContext()) {
                try {
                    const ctx = liff.getContext();
                    if (ctx && ctx.endpointUrl) {
                        const url = new URL(ctx.endpointUrl);
                        mid = url.searchParams.get('machine_id');
                    }
                } catch (e) {
                    console.log('ç„¡æ³•å¾ LIFF Context å–å¾— machine_id');
                }
            }

            if (mid) {
                console.log('åµæ¸¬åˆ°æ©Ÿå°ç·¨è™Ÿ:', mid);
                document.getElementById('machineId').value = mid;
                // é–å®šæ¬„ä½é¿å…æ”¹å‹•
                document.getElementById('machineId').classList.add('locked-input', 'is-filled');
                document.getElementById('machineId').readOnly = true;

                try {
                    // å¾ Supabase æŸ¥è©¢è©³ç´°è³‡æ–™
                    const response = await fetch(
                        `${CONFIG.SUPABASE_URL}/rest/v1/machines?machine_id=eq.${mid}`,
                        {
                            headers: {
                                'apikey': CONFIG.SUPABASE_KEY,
                                'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                            }
                        }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) {
                            machineData = data[0];
                            fillMachineData(machineData);
                            showSyncStatus();
                        }
                    }
                } catch (e) {
                    console.error('æ©Ÿå°è³‡æ–™è¼‰å…¥å¤±æ•—', e);
                }
            } else {
                console.log('æœªåµæ¸¬åˆ°æ©Ÿå°ç·¨è™Ÿï¼Œéœ€æ‰‹å‹•è¼¸å…¥');
            }
        }

        // â­ v15.1: å¡«å……æ©Ÿå°è³‡æ–™
        function fillMachineData(data) {
            const setAndLock = (id, value) => {
                const el = document.getElementById(id);
                if (el && value != null && value !== '') {
                    el.value = value;
                    el.classList.add('locked-input', 'is-filled');
                    el.readOnly = true;
                }
            };

            // å¡«å……ä¸¦é–å®šåŸºæœ¬è³‡æ–™
            setAndLock('machineName', data.machine_name);
            setAndLock('vendorName', data.vendor);
            setAndLock('tankSize', data.capacity);
            setAndLock('targetConc', data.target_conc);

            // å¡«å……æ²¹å“é¡å‹
            if (data.oil_code) {
                const oilType = document.getElementById('oilType');
                const code = String(data.oil_code).trim();
                if (code === '1') {
                    oilType.value = 'é¸é … 1ï¼šå…¨åˆæˆ (Fully Synthetic)';
                } else if (code === '2') {
                    oilType.value = 'é¸é … 2ï¼šåŠåˆæˆ (Semi-Synthetic)';
                }
                markFilled(oilType);
                updateHints();
            }

            // é¡¯ç¤ºæ­·å²æ•¸æ“šæç¤º
            if (data.last_ph) {
                document.getElementById('phLastValue').textContent = `ğŸ’¡ ä¸Šæ¬¡ï¼špH ${data.last_ph}`;
            }
            if (data.last_brix) {
                document.getElementById('brixLastValue').textContent = `ğŸ’¡ ä¸Šæ¬¡ï¼š${data.last_brix}%`;
            }
        }

        // ========== é¡¯ç¤ºç•«é¢ ==========
        
        // é¡¯ç¤ºè¨»å†Šè¡¨å–®
        function showRegistrationForm() {
            elements.loadingScreen.classList.remove('active');
            elements.loadingScreen.classList.add('hidden');
            elements.registerForm.classList.add('active');
        }

        // é¡¯ç¤ºæª¢æ¸¬è¡¨å–®
        function showInspectionForm() {
            elements.loadingScreen.classList.remove('active');
            elements.loadingScreen.classList.add('hidden');
            elements.inspectionForm.classList.add('active');

            // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
            elements.userInfo.innerHTML = `
                <p><strong>ğŸ‘¤ æ“ä½œäººå“¡ï¼š</strong>${userData.real_name}</p>
                <p><strong>ğŸ¢ å…¬å¸ï¼š</strong>${getCompanyName(userData.company_code)}</p>
                <p><strong>ğŸ‘” è§’è‰²ï¼š</strong>${userData.role}</p>
            `;

            // é å¡«å» å•†åç¨±ï¼ˆå¦‚æœæ²’æœ‰è¢«æ©Ÿå°è³‡æ–™é–å®šï¼‰
            if (userData.company_code && userData.company_code !== 'OTHER') {
                const vendorName = document.getElementById('vendorName');
                if (!vendorName.readOnly) {
                    vendorName.value = getCompanyName(userData.company_code);
                }
            }
        }

        // ========== è¡¨å–®è™•ç† ==========
        
        // è™•ç†è¨»å†Šè¡¨å–®æäº¤
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const realName = document.getElementById('realName').value.trim();
            const companyCode = document.getElementById('companyCode').value;
            const userRole = document.getElementById('userRole').value;

            if (!realName) {
                showError('è«‹è¼¸å…¥å§“å');
                return;
            }

            if (realName.length < 2 || realName.length > 20) {
                showError('å§“åé•·åº¦æ‡‰ç‚º 2-20 å€‹å­—å…ƒ');
                return;
            }

            // é¡¯ç¤º Loading
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'è¨»å†Šä¸­...';

            try {
                // å„²å­˜åˆ° Supabase
                const response = await fetch(
                    `${CONFIG.SUPABASE_URL}/rest/v1/users`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': CONFIG.SUPABASE_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            user_id: liffProfile.userId,
                            real_name: realName,
                            role: userRole,
                            company_code: companyCode,
                            last_login: new Date().toISOString()
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error('è¨»å†Šå¤±æ•—');
                }

                const data = await response.json();
                userData = data[0];

                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showSuccess('è¨»å†ŠæˆåŠŸï¼');

                // â­ v15.1: è¼‰å…¥æ©Ÿå°è³‡æ–™
                updateLoadingText('æ­£åœ¨è¼‰å…¥æ©Ÿå°è³‡æ–™...');
                await loadMachineData();

                // å»¶é² 1 ç§’å¾Œé¡¯ç¤ºæª¢æ¸¬è¡¨å–®
                setTimeout(() => {
                    elements.registerForm.classList.remove('active');
                    showInspectionForm();
                }, 1000);

            } catch (error) {
                console.error('è¨»å†ŠéŒ¯èª¤:', error);
                showError('è¨»å†Šå¤±æ•—ï¼Œè«‹é‡è©¦');
                submitBtn.disabled = false;
                submitBtn.textContent = 'å®Œæˆè¨»å†Š';
            }
        });

        // è™•ç†æª¢æ¸¬è¡¨å–®æäº¤
        document.getElementById('inspectionFormData').addEventListener('submit', async (e) => {
            e.preventDefault();

            // æ”¶é›†è¡¨å–®è³‡æ–™
            const machineId = document.getElementById('machineId').value.trim();
            const phValue = parseFloat(document.getElementById('phValue').value) || 0;
            const brixReading = parseFloat(document.getElementById('brixReading').value) || 0;
            const tankSize = parseFloat(document.getElementById('tankSize').value) || 0;
            const oilType = document.getElementById('oilType').value;
            
            // â­ v15.1: æ¸…ç†æ¸¬è©¦çµæœ
            const bubbleResult = cleanTestResult(document.getElementById('bubbleResult').value);
            const resazurinColor = cleanTestResult(document.getElementById('resazurinColor').value);

            const formData = {
                // ä½¿ç”¨è€…è³‡è¨Š
                user_id: liffProfile.userId,
                real_name: userData.real_name,
                role: userData.role,
                
                // æ©Ÿå°è³‡è¨Š
                machine_id: machineId,
                machine_name: document.getElementById('machineName').value.trim() || 'æœªæä¾›',
                vendor_name: document.getElementById('vendorName').value.trim() || 'æœªè¨­å®š',
                
                // æª¢æ¸¬æ•¸æ“š
                oil_type: oilType,
                ph_value: phValue,
                brix_reading: brixReading,
                tank_size: tankSize,
                target_conc: parseFloat(document.getElementById('targetConc').value) || 0,
                conductivity: parseFloat(document.getElementById('conductivity').value) || 0,
                bubble_result: bubbleResult,
                resazurin_color: resazurinColor,
                symptoms: document.getElementById('symptoms').value || ''
            };

            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!machineId) {
                showError('è«‹è¼¸å…¥æ©Ÿå°ç·¨è™Ÿ');
                return;
            }

            if (!oilType) {
                showError('è«‹é¸æ“‡åˆ‡å‰Šæ¶²ç¨®é¡');
                return;
            }

            // é¡¯ç¤º Loading
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';

            try {
                // â­ v15.1: æ›´æ–° Supabase æ©Ÿå°è³‡æ–™
                if (machineData) {
                    const oilCode = oilType.includes('é¸é … 1') ? '1' : '2';
                    await fetch(
                        `${CONFIG.SUPABASE_URL}/rest/v1/machines?machine_id=eq.${machineId}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'apikey': CONFIG.SUPABASE_KEY,
                                'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                capacity: tankSize,
                                target_conc: formData.target_conc,
                                oil_code: oilCode,
                                last_ph: phValue,
                                last_brix: brixReading,
                                last_checked: new Date().toISOString()
                            })
                        }
                    );
                }

                // æäº¤åˆ° Webhook
                const response = await fetch(CONFIG.WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error('æäº¤å¤±æ•—');
                }

                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showSuccess('æª¢æ¸¬è³‡æ–™å·²æäº¤ï¼å ±å‘Šå°‡é€é LINE ç™¼é€çµ¦æ‚¨ã€‚');

                // å»¶é² 2 ç§’å¾Œé—œé–‰ LIFF
                setTimeout(() => {
                    if (liff.isInClient()) {
                        liff.closeWindow();
                    }
                }, 2000);

            } catch (error) {
                console.error('æäº¤éŒ¯èª¤:', error);
                showError('æäº¤å¤±æ•—ï¼Œè«‹é‡è©¦');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸš€ æäº¤æª¢æ¸¬';
            }
        });

        // ========== äº‹ä»¶ç›£è½ ==========
        
        // æ²¹å“é¡å‹è®Šæ›´æ™‚æ›´æ–°æç¤º
        document.getElementById('oilType').addEventListener('change', updateHints);

        // ç›£è½è¼¸å…¥äº‹ä»¶ä»¥æ¨™è¨˜å·²å¡«å¯«
        document.querySelectorAll('.form-control, .form-select').forEach(el => {
            el.addEventListener('input', () => markFilled(el));
            el.addEventListener('change', () => markFilled(el));
        });

        // ========== é é¢è¼‰å…¥ ==========
        window.addEventListener('DOMContentLoaded', () => {
            initializeLiff();
        });
    </script>
</body>
</html>
