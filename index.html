<script>
        // ===== é…ç½®å€ =====
        const LIFF_ID = '2008738088-3ae3t9Qw';
        const WEBHOOK_URL = 'https://eo9xer4x4f4gjfi.m.pipedream.net/';
        
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://zqufrfytzfgpargbzdlk.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_NFGZcCye1tcmoODXAl6xJQ_4lP3Ywk4';
        
        // åˆå§‹åŒ–
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== è®Šè‰²é‚è¼¯ =====
        function checkInputColor(inputElement) {
            if (inputElement.value && inputElement.value.trim() !== '') {
                inputElement.classList.add('is-filled');
            } else {
                inputElement.classList.remove('is-filled');
            }
        }

        function updateRangeHints() {
            // (ä¿ç•™åŸæœ¬é‚è¼¯ï¼Œçœç•¥ä»¥ç¯€çœç¯‡å¹…)
            checkInputColor(document.getElementById('oil-type'));
        }

        // ===== æ ¸å¿ƒï¼šè®€å–è³‡æ–™ (è¨ºæ–·ç‰ˆ) =====
        async function loadMachineData(machineId) {
            // ğŸš¨ è¨ºæ–· 2ï¼šé–‹å§‹æŸ¥è©¢è³‡æ–™åº«
            // alert(`è¨ºæ–· 2: æ­£åœ¨å‘ Supabase æŸ¥è©¢ ID: ${machineId}`);
            
            try {
                const { data, error } = await supabase
                    .from('machines')
                    .select('*')
                    .eq('machine_id', machineId)
                    .single();

                if (error) {
                    alert(`âŒ è³‡æ–™åº«éŒ¯èª¤: ${error.message}\n(è«‹æª¢æŸ¥ Supabase RLS æ¬Šé™)`);
                    console.error('Supabase Error:', error);
                    return null;
                }
                
                if (!data) {
                    alert(`âš ï¸ æ‰¾ä¸åˆ°è³‡æ–™: è³‡æ–™åº«è£¡æ²’æœ‰ ${machineId}`);
                    return null;
                }

                // ğŸš¨ è¨ºæ–· 3ï¼šæˆåŠŸæŠ“åˆ°è³‡æ–™ï¼Œé¡¯ç¤ºæ¬„ä½åç¨±
                // é€™è£¡æœƒåˆ—å‡ºè³‡æ–™åº«å›å‚³çš„æ‰€æœ‰æ¬„ä½ï¼Œè®“æˆ‘å€‘æª¢æŸ¥å¤§å°å¯«æ˜¯å¦æ­£ç¢º
                // alert(`âœ… æŠ“åˆ°è³‡æ–™äº†ï¼\næ¬„ä½: ${Object.keys(data).join(', ')}`);
                
                return data;

            } catch (err) {
                alert(`âŒ ç¨‹å¼éŒ¯èª¤: ${err.message}`);
                return null;
            }
        }

        // ===== å•Ÿå‹•é‚è¼¯ =====
        async function initFormLogic() {
            const urlParams = new URLSearchParams(window.location.search);
            let machineId = urlParams.get('machine_id');

            // LIFF Context å‚™æ´
            if (!machineId && liff.getContext()) {
                if (liff.getContext().endpointUrl.indexOf('?') > -1) {
                    const query = liff.getContext().endpointUrl.split('?')[1];
                    const params = new URLSearchParams(query);
                    machineId = params.get('machine_id');
                }
            }
            
            // ğŸš¨ è¨ºæ–· 1ï¼šç¢ºèª ID æ˜¯å¦å­˜åœ¨
            if (!machineId) {
                // alert("âš ï¸ è­¦å‘Š: ç¶²å€ä¸­æ²’æœ‰ machine_id åƒæ•¸ï¼");
                return;
            } else {
                // alert(`è¨ºæ–· 1: æˆåŠŸæŠ“åˆ° ID = ${machineId}`);
            }
            
            document.getElementById('machine-id').value = machineId;
            checkInputColor(document.getElementById('machine-id'));
            
            // è¼‰å…¥è³‡æ–™
            const machineData = await loadMachineData(machineId);
            
            if (machineData) {
                // è‡ªå‹•å¡«å…¥ (è«‹æ³¨æ„é€™è£¡çš„æ¬„ä½åç¨±å¿…é ˆè·Ÿè¨ºæ–·3é¡¯ç¤ºçš„ä¸€æ¨¡ä¸€æ¨£)
                
                // 1. æ©Ÿå°åç¨±
                if (machineData.machine_name) {
                    document.getElementById('machine-name').value = machineData.machine_name;
                    checkInputColor(document.getElementById('machine-name'));
                }
                
                // 2. å» å•†
                if (machineData.vendor) { 
                    document.getElementById('vendor-code').value = machineData.vendor;
                    checkInputColor(document.getElementById('vendor-code'));
                }
                
                // 3. å®¹é‡
                if (machineData.capacity) {
                    document.getElementById('tank-size').value = machineData.capacity;
                    checkInputColor(document.getElementById('tank-size'));
                }
                
                // 4. ç›®æ¨™æ¿ƒåº¦
                if (machineData.target_conc) {
                    document.getElementById('target-conc').value = machineData.target_conc;
                    checkInputColor(document.getElementById('target-conc'));
                }
                
                // 5. æ²¹å“ä»£ç¢¼è½‰æ›
                if (machineData.oil_code) {
                    const el = document.getElementById('oil-type');
                    let code = String(machineData.oil_code);
                    if (code === "1" || code === "é¸é … 1") el.value = "é¸é … 1";
                    else if (code === "2" || code === "é¸é … 2") el.value = "é¸é … 2";
                    checkInputColor(el);
                    updateRangeHints();
                }
            }
        }

        // ===== LIFF Init =====
        document.addEventListener('DOMContentLoaded', function() {
            liff.init({ liffId: LIFF_ID }).then(async () => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    await initFormLogic();
                }
            }).catch((err) => {
                // alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œå˜—è©¦ç›´æ¥åŸ·è¡Œ...");
                initFormLogic();
            });
        });

        // (è¡¨å–®æäº¤çš„éƒ¨åˆ†ä¿æŒä¸è®Šï¼Œçœç•¥ä»¥ç¯€çœç©ºé–“)
        document.getElementById('diagnostic-form').addEventListener('submit', async function(e) {
             e.preventDefault();
             // ... (æ‚¨çš„æäº¤ä»£ç¢¼) ...
             alert("åŠŸèƒ½æ¸¬è©¦ä¸­ï¼šå°šæœªçœŸæ­£æäº¤");
        });
    </script>
